name: Build

on:
  push:
    tags:        
      - 'v*.*.*'           # Push events to every tag not containing /
  workflow_call:
    inputs:
      repo:
        required: true
        type: string
        description: "'erpnext' or 'frappe'"
      version:
        required: true
        type: string
        description: "Major version, git tags should match 'v{version}.*'; or 'develop'"
      push:
        required: true
        type: boolean
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # - name: Get tag
      #   run: |
      #     TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
      - name: Branch name
        id: git-meta
        run: |
          echo ::set-output name=SOURCE_NAME::${GITHUB_REF#refs/*/}
          echo ::set-output name=SOURCE_BRANCH::${GITHUB_REF#refs/heads/}
          echo ::set-output name=SOURCE_TAG::${GITHUB_REF#refs/tags/}

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v2
        with:
          driver-opts: network=host

      - name: Echo version of get-meta
        run: |
          echo ${TAG}
        env:
          TAG: ${{ steps.git-meta.outputs.SOURCE_TAG }}

      - name: Build
        uses: docker/bake-action@v2.3.0
        env:
          APPS_JSON_BASE64: WyB7ICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2ZyYXBwZS9wYXltZW50cyIsICJicmFuY2giOiAiZGV2ZWxvcCIgfSwgeyAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9mcmFwcGUvZXJwbmV4dCIsICJicmFuY2giOiAidmVyc2lvbi0xNCIgfSwgeyAidXJsIjogImh0dHBzOi8vZ2l0aHViLmNvbS9mcmFwcGUvbG1zIiwgImJyYW5jaCI6ICJtYWluIiB9LCB7ICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL2ZyYXBwZS9jaGF0IiwgImJyYW5jaCI6ICJtYWluIiB9LCB7ICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL3lyZXN0b20vUE9TLUF3ZXNvbWUiLCAiYnJhbmNoIjogInZlcnNpb24tMTQiIH0sIHsgInVybCI6ICJodHRwczovL2hpZXV0cmx1dToke1BFUlNPTkFMX0FDQ0VTU19UT0tFTn1AZ2l0aHViLmNvbS9odGwtZGlnaXRhbGl6YXRpb24vdHBwX2N1c3RvbSIsICJicmFuY2giOiAibWFpbiIgfSwgeyAidXJsIjogImh0dHBzOi8vaGlldXRybHV1OiR7UEVSU09OQUxfQUNDRVNTX1RPS0VOfUBnaXRodWIuY29tL2h0bC1kaWdpdGFsaXphdGlvbi90cHBfbWFudWZhY3R1cmluZyIsICJicmFuY2giOiAibWFpbiIgfSBdCg==
          PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          TAG: ${{ steps.git-meta.outputs.SOURCE_TAG }}
          IMAGE_NAME: tpp-erpnext
          REGISTRY_NAME: hieutrluu
          REGISTRY_USER: localhost:5000/hieutrluu
        with:
          push: true
          context: .
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # - name: Setup Python
      #   uses: actions/setup-python@v4
      #   with:
      #     python-version: "3.10"

      # - name: Install dependencies
      #   run: |
      #     python -m venv venv
      #     venv/bin/pip install -r requirements-test.txt

      # - name: Test
      #   run: venv/bin/pytest --color=yes

      - name: Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push
        uses: docker/bake-action@v2.3.0
        with:
          push: true
